<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>8.4-巡检与自动化脚本 | 运维规范文档</title>
  <link rel="stylesheet" href="/KOpsDoc/assets/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
  <script>
    var BASEURL = "/KOpsDoc";
  </script>
  <script src="/KOpsDoc/assets/js/search.js" defer></script>
  <script src="/KOpsDoc/assets/js/theme.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.mermaid) {
        mermaid.initialize({ startOnLoad: false });
        document.querySelectorAll('code.language-mermaid, code.mermaid').forEach(function(block, i) {
          var pre = block.parentElement;
          var code = block.textContent;
          var container = document.createElement('div');
          container.className = 'mermaid';
          container.textContent = code;
          pre.parentNode.replaceChild(container, pre);
          try { mermaid.init(undefined, container); } catch(e) {}
        });
      }
    });
  </script>
</head>
<body>
  <header class="book-header">
    <a href="/KOpsDoc/" class="book-logo" aria-label="返回首页">运维规范文档</a>
    <button id="theme-toggle" onclick="toggleTheme()" aria-label="切换主题" type="button">
      <i id="theme-toggle-icon" class="ti ti-moon-stars"></i>
    </button>
  </header>
  <div class="book-container">
    <aside class="book-sidebar">
      <nav>
        <input type="search" id="doc-search" placeholder="搜索文档..." autocomplete="off" />
        <div id="search-results" class="search-results"></div>
        <h2>文档导航</h2>
        <ul>
        
        
        
        
          <li class="nav-group"><strong>0. 目录与索引</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/%E7%9B%AE%E5%BD%95%E6%B8%85%E5%8D%95.html">目录清单</a></li>
              
            
              
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>1. 基础通用规范</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/1.1-%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83.html">1.1-基础设施命名规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/1.2-%E4%B8%BB%E6%9C%BA%E4%B8%8E%E8%B5%84%E4%BA%A7%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">1.2-主机与资产管理规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/1.3-%E8%B4%A6%E5%8F%B7%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">1.3-账号与权限管理规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/1.4-%E6%96%87%E6%A1%A3%E4%B8%8E%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">1.4-文档与知识管理规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>2. 变更与发布管理</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/2.1-%E5%8F%98%E6%9B%B4%E4%B8%8E%E5%8F%91%E5%B8%83%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">2.1-变更与发布管理规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/2.1-%E5%8F%98%E6%9B%B4%E4%B8%8E%E5%8F%91%E5%B8%83%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83-%E6%A1%88%E4%BE%8B%E9%9B%86%E9%94%A6.html">2.1-变更与发布管理规范-案例集锦</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/2.2-%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B8%8E%E8%84%9A%E6%9C%AC%E8%A7%84%E8%8C%83.html">2.2-自动化运维与脚本规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/2.3-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B8%8E%E6%BC%94%E7%BB%83%E8%A7%84%E8%8C%83.html">2.3-自动化测试与演练规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>3. 监控与可观测性</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/3.1-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E8%A7%84%E8%8C%83.html">3.1-监控与告警规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/3.1-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E8%A7%84%E8%8C%83-%E6%B5%81%E7%A8%8B%E5%9B%BE.html">3.1-监控与告警规范-流程图</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/3.2-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E8%A7%84%E8%8C%83.html">3.2-日志与可观测性规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/3.3-%E8%BF%90%E7%BB%B4%E8%B4%A8%E9%87%8F%E4%B8%8E%E6%95%88%E8%83%BD%E5%BA%A6%E9%87%8F%E8%A7%84%E8%8C%83.html">3.3-运维质量与效能度量规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>4. 安全与合规</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/4.1-%E5%AE%89%E5%85%A8%E5%90%88%E8%A7%84%E4%B8%8E%E5%AE%A1%E8%AE%A1%E8%A7%84%E8%8C%83.html">4.1-安全合规与审计规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/4.2-%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E4%B8%8E%E9%9A%90%E7%A7%81%E4%BF%9D%E6%8A%A4%E8%A7%84%E8%8C%83.html">4.2-数据安全与隐私保护规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/4.3-%E8%BF%90%E7%BB%B4%E5%AE%89%E5%85%A8%E5%BA%94%E6%80%A5%E6%BC%94%E7%BB%83%E8%A7%84%E8%8C%83.html">4.3-运维安全应急演练规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>5. 云原生与智能运维</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/5.1-%E5%AE%B9%E5%99%A8%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E8%BF%90%E7%BB%B4%E8%A7%84%E8%8C%83.html">5.1-容器与云原生运维规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/5.2-CI_CD%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%A7%84%E8%8C%83.html">5.2-CI_CD流水线与自动化规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/5.3-%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%8D%B3%E4%BB%A3%E7%A0%81%EF%BC%88IaC%EF%BC%89%E8%A7%84%E8%8C%83.html">5.3-基础设施即代码（IaC）规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/5.4-%E5%A4%9A%E4%BA%91%E4%B8%8E%E6%B7%B7%E5%90%88%E4%BA%91%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">5.4-多云与混合云管理规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/5.5-AIOps%E4%B8%8E%E6%99%BA%E8%83%BD%E8%BF%90%E7%BB%B4%E8%A7%84%E8%8C%83.html">5.5-AIOps与智能运维规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>6. 运营与可持续发展</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/6.1-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E8%A7%84%E8%8C%83.html">6.1-备份与恢复规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/6.2-%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E5%A4%96%E5%8C%85%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83.html">6.2-供应商与外包管理规范</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/6.3-%E7%BB%BF%E8%89%B2%E8%BF%90%E7%BB%B4%E4%B8%8E%E5%8F%AF%E6%8C%81%E7%BB%AD%E5%8F%91%E5%B1%95%E8%A7%84%E8%8C%83.html">6.3-绿色运维与可持续发展规范</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>7. 工具与补充清单</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/7.1-%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E6%B8%85%E5%8D%95.html">7.1-运维常用工具清单</a></li>
              
            
            </ul>
          </li>
        
          <li class="nav-group"><strong>8. 补充SOP与实用手册</strong>
            <ul>
            
              
              
                
                <li><a href="/KOpsDoc/8.1-%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5SOP.html">8.1-安全策略SOP</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/8.2-%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B.html">8.2-灾难恢复流程</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/8.3-DevOps%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B.html">8.3-DevOps发布流程</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/8.4-%E5%B7%A1%E6%A3%80%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC.html" class="active">8.4-巡检与自动化脚本</a></li>
              
            
              
              
                
                <li><a href="/KOpsDoc/8.5-%E5%80%BC%E7%8F%AD%E6%89%8B%E5%86%8C.html">8.5-值班手册</a></li>
              
            
            </ul>
          </li>
        </ul>
      </nav>
    </aside>
    <main class="book-content">
      <article>
        
        <h1 id="84-巡检与自动化脚本">8.4 巡检与自动化脚本</h1>

<h2 id="一适用范围与目标">一、适用范围与目标</h2>

<ul>
  <li>适用于系统、服务、基础设施等的日常巡检和自动化运维脚本管理。</li>
  <li>目标：建立标准化的巡检流程，提升运维效率，降低人工成本，保障系统稳定。</li>
</ul>

<h2 id="二管理目标">二、管理目标</h2>

<ol>
  <li>巡检任务标准化、自动化，覆盖关键指标</li>
  <li>脚本开发规范，可维护、可复用</li>
  <li>巡检结果可追溯，异常自动告警</li>
  <li>脚本库统一管理，版本可控</li>
</ol>

<h2 id="三详细规范">三、详细规范</h2>

<h3 id="定时巡检任务">定时巡检任务</h3>

<ul>
  <li><strong>巡检内容</strong>：
    <ul>
      <li>节点健康状态（Kubernetes 节点、主机状态）</li>
      <li>磁盘空间使用率（&gt;80% 告警）</li>
      <li>证书有效期（&lt;30 天告警）</li>
      <li>备份状态（备份是否成功、备份文件完整性）</li>
      <li>服务可用性（关键服务是否正常运行）</li>
      <li>资源使用率（CPU、内存、网络）</li>
    </ul>
  </li>
  <li><strong>巡检频率</strong>：每日/每周/每月，根据重要性确定</li>
  <li><strong>巡检工具</strong>：cron、Ansible、Prometheus Alert、自定义脚本</li>
  <li><strong>告警机制</strong>：异常自动告警，通知相关人员</li>
</ul>

<h3 id="脚本开发规范">脚本开发规范</h3>

<ul>
  <li><strong>开发语言</strong>：统一使用 Python、Shell、Go 等</li>
  <li><strong>代码规范</strong>：遵循团队代码规范，注释清晰</li>
  <li><strong>参数化设计</strong>：支持参数输入，便于复用</li>
  <li><strong>异常处理</strong>：完善的异常处理和日志记录</li>
  <li><strong>幂等性</strong>：脚本执行多次结果一致</li>
  <li><strong>文档说明</strong>：每个脚本需有 README 说明</li>
</ul>

<h3 id="脚本库管理">脚本库管理</h3>

<ul>
  <li><strong>版本控制</strong>：所有脚本纳入 Git 版本控制</li>
  <li><strong>统一存储</strong>：脚本统一存储在脚本库（如 GitLab、GitHub）</li>
  <li><strong>分类管理</strong>：按功能分类（巡检、部署、备份等）</li>
  <li><strong>权限管理</strong>：脚本访问权限控制，敏感脚本加密</li>
  <li><strong>定期评审</strong>：定期评审脚本，优化和重构</li>
</ul>

<h2 id="四操作流程">四、操作流程</h2>

<h3 id="巡检任务配置流程">巡检任务配置流程</h3>

<ol>
  <li><strong>确定巡检项</strong> → 根据业务需求确定巡检内容</li>
  <li><strong>编写巡检脚本</strong> → 开发或选择现有脚本</li>
  <li><strong>配置定时任务</strong> → 配置 cron 或调度系统</li>
  <li><strong>测试验证</strong> → 在测试环境验证脚本功能</li>
  <li><strong>上线运行</strong> → 部署到生产环境</li>
  <li><strong>监控告警</strong> → 配置异常告警规则</li>
  <li><strong>定期优化</strong> → 根据巡检结果优化脚本</li>
</ol>

<h3 id="脚本开发流程">脚本开发流程</h3>

<ol>
  <li><strong>需求分析</strong> → 明确脚本功能和需求</li>
  <li><strong>设计开发</strong> → 编写脚本代码</li>
  <li><strong>代码评审</strong> → 代码提交前进行评审</li>
  <li><strong>测试验证</strong> → 在测试环境验证功能</li>
  <li><strong>文档编写</strong> → 编写 README 和使用说明</li>
  <li><strong>提交入库</strong> → 提交到脚本库</li>
  <li><strong>上线使用</strong> → 部署到生产环境使用</li>
</ol>

<h3 id="脚本维护流程">脚本维护流程</h3>

<ol>
  <li><strong>问题反馈</strong> → 收集脚本使用中的问题</li>
  <li><strong>问题分析</strong> → 分析问题原因</li>
  <li><strong>优化改进</strong> → 优化脚本代码</li>
  <li><strong>测试验证</strong> → 验证改进效果</li>
  <li><strong>更新文档</strong> → 更新相关文档</li>
  <li><strong>版本发布</strong> → 发布新版本</li>
</ol>

<h2 id="五实际案例">五、实际案例</h2>

<h3 id="案例1kubernetes-集群巡检">案例1：Kubernetes 集群巡检</h3>

<ul>
  <li><strong>场景</strong>：每日巡检 Kubernetes 集群健康状态</li>
  <li><strong>巡检内容</strong>：
    <ul>
      <li>节点 Ready 状态</li>
      <li>Pod 异常状态</li>
      <li>资源使用率</li>
      <li>证书有效期</li>
    </ul>
  </li>
  <li><strong>实现方式</strong>：Ansible Playbook + Prometheus Alert</li>
  <li><strong>结果</strong>：每日自动巡检，异常自动告警</li>
  <li><strong>亮点</strong>：自动化巡检，及时发现问题</li>
</ul>

<h3 id="案例2磁盘空间巡检">案例2：磁盘空间巡检</h3>

<ul>
  <li><strong>场景</strong>：每周巡检服务器磁盘空间</li>
  <li><strong>巡检内容</strong>：
    <ul>
      <li>磁盘使用率 &gt;80% 告警</li>
      <li>磁盘使用率 &gt;90% 紧急告警</li>
      <li>大文件识别和清理建议</li>
    </ul>
  </li>
  <li><strong>实现方式</strong>：Shell 脚本 + cron</li>
  <li><strong>结果</strong>：提前发现磁盘空间不足，及时处理</li>
  <li><strong>亮点</strong>：分级告警，提供处理建议</li>
</ul>

<h3 id="案例3证书有效期巡检">案例3：证书有效期巡检</h3>

<ul>
  <li><strong>场景</strong>：每月巡检 SSL 证书有效期</li>
  <li><strong>巡检内容</strong>：
    <ul>
      <li>证书有效期 &lt;30 天告警</li>
      <li>证书有效期 &lt;7 天紧急告警</li>
      <li>证书即将过期提醒</li>
    </ul>
  </li>
  <li><strong>实现方式</strong>：Python 脚本 + 邮件通知</li>
  <li><strong>结果</strong>：提前发现证书即将过期，及时续期</li>
  <li><strong>亮点</strong>：提前预警，避免证书过期</li>
</ul>

<h2 id="六操作模板">六、操作模板</h2>

<h3 id="巡检脚本模板shell">巡检脚本模板（Shell）</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># 巡检脚本模板</span>
<span class="c"># 功能：检查系统健康状态</span>
<span class="c"># 作者：运维团队</span>
<span class="c"># 日期：2024-01-01</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/health-check.log"</span>
<span class="nv">ALERT_EMAIL</span><span class="o">=</span><span class="s2">"ops@example.com"</span>

<span class="c"># 日志函数</span>
log<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"[</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="si">)</span><span class="s2">] </span><span class="nv">$1</span><span class="s2">"</span> | <span class="nb">tee</span> <span class="nt">-a</span> <span class="k">${</span><span class="nv">LOG_FILE</span><span class="k">}</span>
<span class="o">}</span>

<span class="c"># 告警函数</span>
alert<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"ALERT: </span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> | mail <span class="nt">-s</span> <span class="s2">"系统告警"</span> <span class="k">${</span><span class="nv">ALERT_EMAIL</span><span class="k">}</span>
<span class="o">}</span>

<span class="c"># 检查节点健康</span>
check_nodes<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"检查 Kubernetes 节点状态..."</span>
    <span class="nv">NOT_READY</span><span class="o">=</span><span class="si">$(</span>kubectl get nodes | <span class="nb">grep</span> <span class="nt">-v</span> Ready | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">NOT_READY</span><span class="k">}</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>alert <span class="s2">"发现 </span><span class="k">${</span><span class="nv">NOT_READY</span><span class="k">}</span><span class="s2"> 个节点不健康"</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 检查磁盘空间</span>
check_disk<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"检查磁盘空间..."</span>
    <span class="nb">df</span> <span class="nt">-h</span> | <span class="nb">awk</span> <span class="s1">'NR&gt;1 {if ($5+0 &gt; 80) print "磁盘使用率告警: " $1 " " $5}'</span>
<span class="o">}</span>

<span class="c"># 主函数</span>
main<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"开始巡检..."</span>
    check_nodes
    check_disk
    log <span class="s2">"巡检完成"</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="巡检脚本模板ansible">巡检脚本模板（Ansible）</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">系统巡检</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">检查节点 Ready 状态</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">kubectl get nodes | grep -v Ready</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">not_ready_nodes</span>
      <span class="na">failed_when</span><span class="pi">:</span> <span class="kc">false</span>
      
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">告警不健康节点</span>
      <span class="na">debug</span><span class="pi">:</span>
        <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">发现不健康节点:</span><span class="nv"> </span><span class="s">"</span>
      <span class="na">when</span><span class="pi">:</span> <span class="s">not_ready_nodes.stdout != ""</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">检查磁盘空间</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">df -h | awk '$5+0 &gt; 80 {print $1 " " $5}'</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">disk_usage</span>
      <span class="na">failed_when</span><span class="pi">:</span> <span class="kc">false</span>
      
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">告警磁盘空间不足</span>
      <span class="na">debug</span><span class="pi">:</span>
        <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">磁盘使用率告警:</span><span class="nv"> </span><span class="s">"</span>
      <span class="na">when</span><span class="pi">:</span> <span class="s">disk_usage.stdout != ""</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">检查证书有效期</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">openssl x509 -in /etc/ssl/certs/cert.pem -noout -enddate</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">cert_expiry</span>
      <span class="na">failed_when</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div>

<h3 id="巡检脚本模板python">巡检脚本模板（Python）</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="sh">"""</span><span class="s">
巡检脚本模板
功能：检查系统健康状态
</span><span class="sh">"""</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">smtplib</span>
<span class="kn">from</span> <span class="n">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(levelname)s - %(message)s</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="p">.</span><span class="nc">FileHandler</span><span class="p">(</span><span class="sh">'</span><span class="s">/var/log/health-check.log</span><span class="sh">'</span><span class="p">),</span>
        <span class="n">logging</span><span class="p">.</span><span class="nc">StreamHandler</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">check_nodes</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">检查 Kubernetes 节点状态</span><span class="sh">"""</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">检查 Kubernetes 节点状态...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="p">[</span><span class="sh">'</span><span class="s">kubectl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">get</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">nodes</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="n">not_ready</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span> <span class="k">if</span> <span class="sh">'</span><span class="s">NotReady</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">not_ready</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">发现不健康节点: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">not_ready</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">check_disk</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">检查磁盘空间</span><span class="sh">"""</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">检查磁盘空间...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="p">[</span><span class="sh">'</span><span class="s">df</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-h</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="c1"># 解析磁盘使用率
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">'</span><span class="s">%</span><span class="sh">'</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">usage</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
                    <span class="n">logging</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">磁盘使用率告警: </span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">usage</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">主函数</span><span class="sh">"""</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">开始巡检...</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">check_nodes</span><span class="p">()</span>
    <span class="nf">check_disk</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">巡检完成</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="cron-配置示例">Cron 配置示例</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 每日凌晨 2 点执行巡检</span>
0 2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/local/bin/health-check.sh <span class="o">&gt;&gt;</span> /var/log/health-check.log 2&gt;&amp;1

<span class="c"># 每周一凌晨 3 点执行完整巡检</span>
0 3 <span class="k">*</span> <span class="k">*</span> 1 /usr/local/bin/full-health-check.sh <span class="o">&gt;&gt;</span> /var/log/full-health-check.log 2&gt;&amp;1

<span class="c"># 每小时检查一次证书有效期</span>
0 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/local/bin/cert-check.sh <span class="o">&gt;&gt;</span> /var/log/cert-check.log 2&gt;&amp;1
</code></pre></div></div>

<h2 id="七注意事项">七、注意事项</h2>

<ul>
  <li><strong>巡检脚本需有日志与告警</strong>：所有巡检脚本需记录日志，异常需告警</li>
  <li><strong>关键巡检项需自动化闭环</strong>：关键巡检项发现问题后自动处理或升级</li>
  <li><strong>脚本变更需评审与测试</strong>：脚本变更需代码评审，在测试环境验证</li>
  <li><strong>脚本权限控制</strong>：生产环境脚本执行需权限控制，避免误操作</li>
  <li><strong>定期优化脚本</strong>：定期评审和优化脚本，提升效率和准确性</li>
  <li><strong>文档维护</strong>：脚本文档需及时更新，保持与代码同步</li>
</ul>

<h2 id="八参考资料">八、参考资料</h2>

<ul>
  <li>《自动化运维脚本最佳实践》</li>
  <li>《企业级巡检与监控白皮书》</li>
  <li>《Ansible 自动化运维指南》</li>
  <li>团队内部脚本库管理制度</li>
</ul>

      </article>
    </main>
  </div>
  <footer class="book-footer">
    <p>© 2026 运维规范文档 | Powered by Jekyll and AI</p>
  </footer>
  <button class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="展开/收起导航" type="button">
    <i class="ti ti-menu-2" style="font-size:1.5em;"></i>
  </button>
</body>
<script>
  // 移动端侧边栏收起/展开逻辑
  (function() {
    function toggleSidebar(open) {
      var sidebar = document.querySelector('.book-sidebar');
      if (!sidebar) return;
      if (open === undefined) {
        sidebar.classList.toggle('open');
      } else if (open) {
        sidebar.classList.add('open');
      } else {
        sidebar.classList.remove('open');
      }
    }

    function handleSidebarBtn() {
      var btn = document.getElementById('sidebarToggleBtn');
      var sidebar = document.querySelector('.book-sidebar');
      if (!btn || !sidebar) return;

      function check() {
        if (window.innerWidth <= 900) {
          btn.style.display = 'flex';
          if (!sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
          }
        } else {
          btn.style.display = 'none';
          sidebar.classList.remove('open');
        }
      }

      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleSidebar();
      });

      // 点击外部关闭侧边栏
      document.addEventListener('click', function(e) {
        if (window.innerWidth > 900) return;
        var sidebar = document.querySelector('.book-sidebar');
        if (sidebar && sidebar.classList.contains('open') && 
            !sidebar.contains(e.target) && 
            e.target !== btn && 
            !btn.contains(e.target)) {
          sidebar.classList.remove('open');
        }
      });

      // ESC 键关闭侧边栏
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          var sidebar = document.querySelector('.book-sidebar');
          if (sidebar && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
          }
        }
      });

      window.addEventListener('resize', check);
      check();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', handleSidebarBtn);
    } else {
      handleSidebarBtn();
    }
  })();
</script>
</html>